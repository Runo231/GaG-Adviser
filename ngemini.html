<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grow a Garden - Dashboard</title>
    
    <style>
        /* Borde para √≠tems alertados */
        .item-card.alerted, .category-modal .alerted-item {
            border: 2.5px solid #ffd600 !important;
            box-shadow: 0 0 0 2px #ffe06644;
        }
        /* Buscador en el modal de categor√≠a */
        .category-search-box {
            width: 94%;
            margin-left: 3%;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color var(--transition-speed);
        }
        .category-search-box:focus {
            border-color: var(--accent-color);
        }
        /* 1. Variables y Tema */
        /* Bot√≥n moderno para ver todos los √≠tems de la categor√≠a */
        .category-items-btn {
            display: block;
            margin: 1.5rem auto 1rem auto;
            padding: 0.7rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 24px;
            border: none;
            background: var(--accent-color);
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: background var(--transition-speed), box-shadow var(--transition-speed);
        }
        .category-items-btn:hover {
            background: var(--accent-color-hover);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        body.dark-theme .category-items-btn {
            background: var(--accent-color);
            color: #fff;
        }
        body.dark-theme .category-items-btn:hover {
            background: var(--accent-color-hover);
        }

        /* Modal mejorado para listado de √≠tems */
        .modal-content.category-modal {
            max-width: 700px;
            max-height: 90vh;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-content.category-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }
        :root {
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 16px;
            --border-radius: 8px;
            --transition-speed: 0.3s;
            
            /* Tema Claro (Default) */
            --bg-primary: #f4f7f9;
            --bg-secondary: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #5a677d;
            --border-color: #e2e8f0;
            --accent-color: #3498db;
            --accent-color-hover: #2980b9;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        body.dark-theme {
            /* Tema Oscuro */
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --accent-color: #4299e1;
            --accent-color-hover: #2b6cb0;
        }

        /* 2. Reseteo y Estilos Base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            line-height: 1.6;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* 3. Cabecera y Navegaci√≥n */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .header h1 {
            font-size: 1.5rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #bdc3c7; /* Gris por defecto */
        }
        
        .status-light.online { background-color: var(--success-color); }
        .status-light.offline { background-color: var(--error-color); }
        
        .last-update {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .theme-switcher {
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-primary);
        }

        /* 4. Secciones y Contenedores */
        .section {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.02);
        }

        body.dark-theme .section-header {
             background-color: rgba(255,255,255,0.02);
        }
        
        .section-title {
            font-size: 1.25rem;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }

        /* 5. Tarjetas de √çtem */
        .item-card {
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            text-align: center;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            cursor: pointer;
        }
        
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .item-image {
            width: 80px;
            height: 80px;
            margin: 0 auto 0.75rem;
            object-fit: contain;
        }

        .item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .item-quantity, .item-countdown {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }
        
        .alert-button {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        
        .alert-button:hover {
            background-color: var(--accent-color-hover);
        }

        .alert-button.active {
            background-color: var(--success-color);
        }

        /* 6. Panel de Alertas */
        .settings-panel {
            padding: 1.5rem;
        }

        .settings-group {
            margin-bottom: 1.5rem;
        }

        .settings-group h3 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .alert-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }
        
        .remove-alert-btn {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .volume-control input[type="range"] {
            flex-grow: 1;
        }

        /* 7. Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
            z-index: 1000;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: transform var(--transition-speed);
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .modal-body p {
            margin-bottom: 0.75rem;
        }
        
        .modal-body strong {
            color: var(--text-secondary);
        }

        /* 8. Utilidades y Responsividad */
        .hidden {
            display: none;
        }

        .error-message {
            background-color: var(--error-color);
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: var(--border-radius);
            margin: 1rem 1.5rem;
        }

        /* Icono wiki: color din√°mico seg√∫n tema */
        #open-wiki-btn svg {
            stroke: #111;
        }
        body.dark-theme #open-wiki-btn svg {
            stroke: #fff;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 0.75rem;
                padding: 1rem;
            }
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 1rem;
                padding: 1rem;
            }
            .item-card {
                padding: 0.75rem;
            }
            .item-image {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>

    <audio id="alert-sound" src="https://www.sonidosmp3gratis.com/sounds/SD_ALERT_28.mp3" preload="auto"></audio>
    
    <div id="item-info-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Detalles del √çtem</h2>
                <button id="modal-close-btn" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <p>Cargando...</p>
            </div>
        </div>
    </div>
    
    <header class="header">
        <h1>Grow a Garden Dashboard</h1>
        <div class="header-controls">
            <div class="status">
                <div id="status-light" class="status-light"></div>
                <span id="last-update" class="last-update">Nunca</span>
            </div>
            <button id="theme-switcher" class="theme-switcher" title="Cambiar tema">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </header>

    <main class="container">

        <div id="error-container"></div>

        <!-- Secci√≥n de alerta de √≠tems nuevos -->
        <section id="new-alerted-items-section" class="section" style="display:none;margin-bottom:1.5rem;">
            <div class="section-header">
                <h2 class="section-title">¬°Nuevo √≠tem disponible para comprar!</h2>
            </div>
            <div id="new-alerted-items-container" class="grid-container"></div>
        </section>

        <section class="section">
            <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;">
                <h2 class="section-title">Clima Actual</h2>
                <button id="weather-fav-btn" class="category-items-btn" style="margin:0;min-width:unset;font-size:1rem;padding:0.4rem 1.2rem;">+ Filtro de Clima</button>
            </div>
            <div id="weather-container" class="grid-container">
                <p style="padding: 1.5rem; color: var(--text-secondary);">Cargando clima...</p>
            </div>
        </section>

        <section class="section" id="alert-config-section">
            <div class="section-header" id="alert-config-header" style="cursor:pointer;"><h2 class="section-title">Configuraci√≥n de Alertas</h2></div>
            <div class="settings-panel" id="alert-config-panel">
                <div class="settings-group">
                <button id="open-dialog-btn-all-items" class="category-items-btn" style="margin-top:0;margin-bottom:1rem;">Ver todos los √≠tems</button>
                    <h3>Mercader Ambulante</h3>
                    <div class="toggle-switch">
                        <span>Notificar cuando aparezca</span>
                        <input type="checkbox" id="traveling-merchant-alert-toggle">
                    </div>
                </div>
                <div class="settings-group">
                    <h3>Alertas de √çtems Activas</h3>
                    <div id="alert-list">
                        <p>No has a√±adido ninguna alerta. Haz clic en "+ Alerta" en cualquier √≠tem.</p>
                    </div>
                </div>
                <div class="settings-group">
                    <h3>A√±adir alerta por nombre</h3>
                    <form id="manual-alert-form" style="display:flex;gap:0.5rem;align-items:center;margin-bottom:1rem;">
                        <input type="text" id="manual-alert-input" class="category-search-box" placeholder="Nombre del √≠tem..." style="flex:1; width: 100%; margin: 0.5rem 0 0 0" autocomplete="off">
                        <button type="submit" class="category-items-btn" style="padding:0.4rem 1.2rem;">A√±adir</button>
                    </form>
                    <div id="manual-alert-error" style="color:var(--error-color);font-size:0.95em;"></div>
                </div>
                <div class="settings-group">
                    <h3>Volumen</h3>
                    <div class="volume-control">
                        <span>üîá</span>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
                        <span>üîä</span>
                    </div>
                </div>
            </div>
        </section>
        
        <div id="stock-sections"></div>

    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- FAVORITOS DE CLIMA ---
        function showWeatherFavDialog() {
        const allWeathers = state.allWeathers || [];

        let modal = document.createElement('div');
        modal.className = 'modal-overlay visible';
        modal.style.zIndex = '2000';

        // Funci√≥n para renderizar la lista filtrada
        function renderWeatherList(filter = '') {
            const listContainer = modal.querySelector('#weather-fav-list');
            let filtered = allWeathers;
            if (filter) {
                const f = filter.trim().toLowerCase();
                filtered = allWeathers.filter(w => w.weather_name.toLowerCase().includes(f));
            }
            if (filtered.length === 0) {
                listContainer.innerHTML = '<p>No hay climas disponibles.</p>';
            } else {
                listContainer.innerHTML = filtered.map(w => {
                    const isActive = state.weatherFavs && state.weatherFavs.includes(w.weather_name);
                    const minutes = Math.floor(w.duration / 60);
                    const seconds = String(w.duration % 60).padStart(2, '0');
                    return `
                        <button class="toggle-weather-fav-btn"
                            data-weather="${w.weather_name}"
                            style="
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.6rem 1rem;
                                border-radius: 18px;
                                font-weight: 600;
                                background: ${isActive ? 'var(--success-color)' : 'var(--accent-color)'};
                                color: white;
                                border: none;
                                cursor: pointer;
                                min-width: 250px;
                            ">
                            <img src="${w.icon}" alt="${w.weather_name}" style="width: 24px; height: 24px;" />
                            <span class="weather-name" style="flex: 1;">${isActive ? '‚úì ' : ''}${w.weather_name}</span>
                            <span style="font-size: 0.9em; opacity: 0.8;">${minutes}:${seconds}</span>
                        </button>
                    `;
                }).join('');
            }
            // Reasignar listeners
            listContainer.querySelectorAll('.toggle-weather-fav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const w = btn.dataset.weather;
                    const idx = state.weatherFavs.indexOf(w);
                    const isNowActive = idx === -1;
                    if (isNowActive) state.weatherFavs.push(w);
                    else state.weatherFavs.splice(idx, 1);
                    saveStateToLocalStorage();
                    btn.style.background = isNowActive ? 'var(--success-color)' : 'var(--accent-color)';
                    const nameSpan = btn.querySelector('.weather-name');
                    if (nameSpan) {
                        nameSpan.textContent = (isNowActive ? '‚úì ' : '') + w;
                    }
                });
            });
        }

        modal.innerHTML = `
            <div class="modal-content category-modal">
                <div class="modal-header">
                    <h2 class="modal-title">Filtrar Climas Favoritos</h2>
                    <button class="modal-close" id="close-weather-dialog">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="text" id="weather-fav-search" class="category-search-box" placeholder="Buscar clima...">
                    <div id="weather-fav-list" style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;"></div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Render inicial
        renderWeatherList();

        // Cerrar modal
        modal.querySelector('#close-weather-dialog').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });

        // Buscador din√°mico
        modal.querySelector('#weather-fav-search').addEventListener('input', (e) => {
            renderWeatherList(e.target.value);
        });
    }


        // --- MINIMIZAR SECCI√ìN DE ALERTAS ---
        function setAlertConfigMinimized(minimized) {
            const panel = document.getElementById('alert-config-panel');
            if (minimized) {
                panel.style.display = 'none';
            } else {
                panel.style.display = '';
            }
            localStorage.setItem('alertConfigMinimized', minimized ? '1' : '0');
        }
        function getAlertConfigMinimized() {
            return localStorage.getItem('alertConfigMinimized') === '1';
        }
        
        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const dom = {
            statusLight: document.getElementById('status-light'),
            lastUpdate: document.getElementById('last-update'),
            themeSwitcher: document.getElementById('theme-switcher'),
            weatherContainer: document.getElementById('weather-container'),
            stockSectionsContainer: document.getElementById('stock-sections'),
            alertList: document.getElementById('alert-list'),
            travelingMerchantToggle: document.getElementById('traveling-merchant-alert-toggle'),
            volumeSlider: document.getElementById('volume-slider'),
            alertSound: document.getElementById('alert-sound'),
            errorContainer: document.getElementById('error-container'),
            modal: document.getElementById('item-info-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            categoryDialog: null,
            allItemsDialogBtn: null
        };

        // --- VARIABLES Y CONSTANTES GLOBALES ---
        function formatMoney(amount) {
            if (typeof amount === 'string') amount = parseInt(amount);
            if (isNaN(amount)) return amount;
            return amount.toLocaleString('es-ES');
        }
        async function fetchAllItems() {
            try {
                const response = await fetch('https://api.joshlei.com/v2/growagarden/info');
                if (!response.ok) throw new Error('No se pudo obtener la lista de √≠tems.');
                const items = await response.json();
                state.allItems = items;
                // Actualizar alertas manuales si hay coincidencia por nombre (ignorando may√∫sculas y espacios)
                const norm = n => (n||'').toLowerCase().replace(/\s+/g, '');
                let changed = false;
                state.alerts = state.alerts.map(alert => {
                    if (!alert.id && alert.name) {
                        const found = items.find(i => norm(i.display_name) === norm(alert.name));
                        if (found) {
                            changed = true;
                            return { id: found.item_id, name: found.display_name, icon: found.icon };
                        }
                    }
                    return alert;
                });
                if (changed) {
                    saveStateToLocalStorage();
                    renderAlertList();
                }
            } catch (e) {
                console.error('Error al obtener √≠tems:', e);
                state.allItems = [];
            }
        }
        const API_BASE = 'https://api.joshlei.com/v2/growagarden';
        const API_ROUTES = {
            stock: `${API_BASE}/stock`,
            weather: `${API_BASE}/weather`,
            info: `${API_BASE}/info/`,
            image: `${API_BASE}/image/`,
            event: `${API_BASE}/currentevent`,
        };

        const CATEGORY_MAP = {
            seed_stock: 'Semillas',
            gear_stock: 'Herramientas',
            egg_stock: 'Huevos',
            cosmetic_stock: 'Cosm√©ticos',
            eventshop_stock: 'Tienda de Evento',
            travelingmerchant_stock: 'Mercader Ambulante'
        };
        
        let state = {
            weatherFavs: [], // Climas favoritos
            alerts: [],
            travelingMerchantAlert: false,
            volume: 0.5,
            theme: 'light',
            lastStockData: null,
            itemInfoCache: new Map(),
            countdownTimers: [],
            notifiedItems: [], // [{id, start, end}]
            allItems: [], // Todos los √≠tems del endpoint /info,
            allWeathers: [] // Todos los climas posibles
        };

        // --- FUNCIONES DE INICIALIZACI√ìN Y CONFIGURACI√ìN ---
        
        /**
         * Carga el estado desde localStorage y configura los listeners iniciales.
         */
        function initializeApp() {
            // Listener para a√±adir alerta manual
            const manualAlertForm = document.getElementById('manual-alert-form');
            const manualAlertInput = document.getElementById('manual-alert-input');
            const manualAlertError = document.getElementById('manual-alert-error');
            if (manualAlertForm) {
                manualAlertForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = manualAlertInput.value.trim();
                    if (!name) {
                        manualAlertError.textContent = 'Introduce un nombre de √≠tem.';
                        return;
                    }
                    manualAlertError.textContent = '';
                    addManualNameAlert(name);
                    manualAlertInput.value = '';
                });
            }
            // Minimizar secci√≥n de alertas si corresponde
            setAlertConfigMinimized(getAlertConfigMinimized());
            // Listener para minimizar/expandir secci√≥n de alertas (solo sobre el header o el t√≠tulo)
            document.getElementById('alert-config-header').addEventListener('click', (e) => {
                if (e.target !== e.currentTarget && !e.target.classList.contains('section-title')) return;
                const minimized = !getAlertConfigMinimized();
                setAlertConfigMinimized(minimized);
            });
            // Listener para filtro de clima
            document.getElementById('weather-fav-btn').addEventListener('click', showWeatherFavDialog);
            // Listener para ver todos los √≠tems (sin filtrar)
            dom.allItemsDialogBtn = document.getElementById('open-dialog-btn-all-items');
            if (dom.allItemsDialogBtn) {
                dom.allItemsDialogBtn.addEventListener('click', () => {
                    showCategoryDialog('all_items', state.allItems);
                });
            }
            loadStateFromLocalStorage();
            applyTheme();
            applyVolume();
            renderAlertList();

            // Listeners
            dom.themeSwitcher.addEventListener('click', toggleTheme);
            dom.volumeSlider.addEventListener('input', (e) => setVolume(e.target.value));
            dom.travelingMerchantToggle.addEventListener('change', (e) => {
                state.travelingMerchantAlert = e.target.checked;
                saveStateToLocalStorage();
            });
            dom.modalCloseBtn.addEventListener('click', hideItemInfoModal);
            dom.modal.addEventListener('click', (e) => {
                if (e.target === dom.modal) hideItemInfoModal();
            });

            // Cargar todos los √≠tems posibles
            fetchAllItems().then(() => {
                fetchData();
                startUpdateCycle();
            });
        }
        
        function startUpdateCycle() {
          const now = new Date();
          const currentMs = now.getTime();

          // Calcula el siguiente m√∫ltiplo de 5 minutos
          const next5Min = new Date(now);
          next5Min.setSeconds(20);
          next5Min.setMilliseconds(0);

          const minutes = now.getMinutes();
          const nextModulo = (Math.floor(minutes / 5) + 1) * 5;
          next5Min.setMinutes(nextModulo);

          // Si ya pasamos el minuto XX:05:30, vamos al pr√≥ximo
          if (next5Min.getTime() <= currentMs) {
            next5Min.setMinutes(next5Min.getMinutes() + 5);
          }

          const delay = next5Min.getTime() - currentMs;

          console.log("Esperando", Math.round(delay / 1000), "segundos para recargar...");

          setTimeout(() => {
            fetchData(); // primer llamado
            setInterval(fetchData, 5 * 60 * 1000); // cada 5 minutos
          }, delay);
        }

        // --- MANEJO DE ESTADO Y LOCALSTORAGE ---

        function loadStateFromLocalStorage() {
            state.weatherFavs = JSON.parse(localStorage.getItem('weatherFavs') || '[]');
            state.theme = localStorage.getItem('theme') || 'light';
            state.volume = parseFloat(localStorage.getItem('volume')) || 0.5;
            // Permitir alertas antiguas y nuevas (con o sin id)
            try {
                const alerts = JSON.parse(localStorage.getItem('alerts')) || [];
                state.alerts = Array.isArray(alerts) ? alerts : [];
            } catch { state.alerts = []; }
            state.travelingMerchantAlert = localStorage.getItem('travelingMerchantAlert') === 'true';
            state.notifiedItems = JSON.parse(localStorage.getItem('notifiedItems')) || [];
        }

        function saveStateToLocalStorage() {
            localStorage.setItem('weatherFavs', JSON.stringify(state.weatherFavs));
            localStorage.setItem('theme', state.theme);
            localStorage.setItem('volume', state.volume);
            localStorage.setItem('alerts', JSON.stringify(state.alerts));
            localStorage.setItem('travelingMerchantAlert', state.travelingMerchantAlert);
            localStorage.setItem('notifiedItems', JSON.stringify(state.notifiedItems));
        }

        // --- MANEJO DE TEMA Y VOLUMEN ---

        function applyTheme() {
            document.body.classList.toggle('dark-theme', state.theme === 'dark');
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
            dom.themeSwitcher.innerHTML = state.theme === 'dark' ? sunIcon : moonIcon;
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            saveStateToLocalStorage();
            applyTheme();
        }

        function applyVolume() {
            dom.volumeSlider.value = state.volume;
            dom.alertSound.volume = state.volume;
        }

        function setVolume(volume) {
            state.volume = volume;
            dom.alertSound.volume = volume;
            saveStateToLocalStorage();
        }

        // --- LLAMADAS A LA API Y MANEJO DE DATOS ---

        /**
         * Realiza las llamadas a las APIs de stock y clima.
         */
        async function fetchData() {
            clearError();
            clearAllCountdowns();
            try {
                const [stockResponse, weatherResponse] = await Promise.all([
                    fetch(API_ROUTES.stock),
                    fetch(API_ROUTES.weather)
                ]);
                
                handleRateLimit(stockResponse);
                handleRateLimit(weatherResponse);

                if (!stockResponse.ok || !weatherResponse.ok) {
                    throw new Error('Error al obtener datos de la API.');
                }

                const stockData = await stockResponse.json();
                const weatherData = await weatherResponse.json();

                if (weatherData && Array.isArray(weatherData.weather)) {
                    state.allWeathers = Array.from(new Set(weatherData.weather));
                } else {
                    state.allWeathers = [];
                }

                updateStatus(true);

                const justAlertedItemIds = checkForAlerts(stockData, weatherData);
                state.lastStockData = stockData;

                renderStock(stockData, justAlertedItemIds);
                renderWeather(weatherData);
                renderNewAlertedItemsSection(stockData, justAlertedItemIds);

            } catch (error) {
                console.error('Error en fetchData:', error);
                updateStatus(false);
                displayError(error.message);
            }
        }
        
        function handleRateLimit(response) {
            if (response.status === 429) {
                const retryAfter = response.headers.get('Retry-After');
                let message = 'Demasiadas peticiones.';
                if (retryAfter) {
                    message += ` Por favor, espera ${retryAfter} segundos.`;
                }
                throw new Error(message);
            }
        }

        function updateStatus(isOnline) {
            dom.statusLight.classList.toggle('online', isOnline);
            dom.statusLight.classList.toggle('offline', !isOnline);
            if(isOnline) {
                dom.lastUpdate.textContent = `Actualizado: ${new Date().toLocaleTimeString()}`;
            }
        }

        // --- L√ìGICA DE RENDERIZADO ---

        function renderStock(data) {
            dom.stockSectionsContainer.innerHTML = '';
            // Accept justAlertedItemIds as optional second argument
            let justAlertedItemIds = arguments[1] || [];
            for (const categoryKey in CATEGORY_MAP) {
                let typeFilter = null;
                switch (categoryKey) {
                    case 'seed_stock': typeFilter = 'seed'; break;
                    case 'gear_stock': typeFilter = 'gear'; break;
                    case 'egg_stock': typeFilter = 'egg'; break;
                    case 'cosmetic_stock': typeFilter = 'cosmetic'; break;
                    case 'eventshop_stock': typeFilter = 'event'; break;
                }
                const possibleItems = typeFilter ? state.allItems.filter(i => i.type === typeFilter) : [];

                if (data[categoryKey] && data[categoryKey].length > 0) {
                    const categoryName = CATEGORY_MAP[categoryKey];
                    const sectionEl = document.createElement('section');
                    sectionEl.className = 'section';

                    // Bot√≥n para abrir el di√°logo de selecci√≥n
                    let dialogBtnHtml = '';
                    if (possibleItems.length > 0) {
                        dialogBtnHtml = `<button id="open-dialog-btn-${categoryKey}" class="category-items-btn">Ver todos los √≠tems de la categor√≠a</button>`;
                    }

                    const itemsHtml = data[categoryKey].map(item => createItemCard(item, categoryKey, justAlertedItemIds)).join('');

                    sectionEl.innerHTML = `
                        <div class="section-header"><h2 class="section-title">${categoryName}</h2></div>
                        ${dialogBtnHtml}
                        <div class="grid-container">${itemsHtml}</div>
                    `;
                    dom.stockSectionsContainer.appendChild(sectionEl);

                    // Listener para abrir el di√°logo
                    if (possibleItems.length > 0) {
                        setTimeout(() => {
                            const btn = document.getElementById(`open-dialog-btn-${categoryKey}`);
                            if (btn) {
                                btn.addEventListener('click', () => {
                                    showCategoryDialog(categoryKey, possibleItems);
                                });
                            }
                        }, 0);
                    }
                }
            }

            addCardListeners();
        }

        // Modal para mostrar todos los √≠tems de la categor√≠a o todos los √≠tems
        function showCategoryDialog(categoryKey, items) {
            // Ordenar por precio ascendente, precio 0 al final
            items = items.slice().sort((a, b) => {
                const priceA = parseInt(a.price) || 0;
                const priceB = parseInt(b.price) || 0;
                if (priceA === 0 && priceB === 0) return 0;
                if (priceA === 0) return 1;
                if (priceB === 0) return -1;
                return priceA - priceB;
            });
            let modal = document.createElement('div');
            modal.className = 'modal-overlay visible';
            modal.style.zIndex = '2000';

            // Funci√≥n para renderizar la lista filtrada
            function renderCategoryList(filter = '') {
                const listContainer = modal.querySelector('#category-items-list');
                let filtered = items;
                if (filter) {
                    const f = filter.trim().toLowerCase();
                    filtered = items.filter(i => i.display_name.toLowerCase().includes(f));
                }
                listContainer.innerHTML = filtered.map(item => {
                    const isActive = state.alerts.some(a => a.id === item.item_id);
                    return `
                        <div style="width:180px;background:var(--bg-primary);border-radius:var(--border-radius);border:1px solid var(--border-color);padding:1rem;display:flex;flex-direction:column;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                            <img src="${item.icon}" alt="${item.display_name}" style="width:48px;height:48px;object-fit:contain;margin-bottom:0.5rem;">
                            <div style="font-weight:600;text-align:center;">${item.display_name}</div>
                            <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">${item.rarity || ''}</div>
                            <div style="font-size:0.95rem;margin-bottom:0.5rem;">${item.price && item.price !== '0' ? formatMoney(item.price) + ' ' + item.currency : 'Sin precio'}</div>
                            <button class="toggle-alert-category-btn" data-item-id="${item.item_id}" style="width:100%;padding:0.4rem;border-radius:6px;font-weight:600;background:${isActive ? 'var(--success-color)' : 'var(--accent-color)'};color:white;border:none;cursor:pointer;">${isActive ? '‚úì Alerta Activa' : '+ Activar Alerta'}</button>
                        </div>
                    `;
                }).join('');
                // Reasignar listeners
                listContainer.querySelectorAll('.toggle-alert-category-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const itemId = btn.dataset.itemId;
                        const item = items.find(i => i.item_id === itemId);
                        if (!item) return;
                        const idx = state.alerts.findIndex(a => a.id === itemId);
                        if (idx > -1) {
                            state.alerts.splice(idx, 1);
                        } else {
                            state.alerts.push({ id: item.item_id, name: item.display_name, icon: item.icon });
                        }
                        saveStateToLocalStorage();
                        renderAlertList();
                        btn.textContent = idx > -1 ? '+ Activar Alerta' : '‚úì Alerta Activa';
                        btn.style.background = idx > -1 ? 'var(--accent-color)' : 'var(--success-color)';
                    });
                });
            }

            let dialogTitle = categoryKey === 'all_items' ? 'Todos los √çtems' : CATEGORY_MAP[categoryKey];
            modal.innerHTML = `
                <div class="modal-content category-modal">
                    <div class="modal-header">
                        <h2 class="modal-title">${dialogTitle}</h2>
                        <button class="modal-close" id="close-category-dialog">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="category-items-search" class="category-search-box" placeholder="Buscar √≠tem...">
                        <div id="category-items-list" style="display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            dom.categoryDialog = modal;

            // Render inicial
            renderCategoryList();

            // Cerrar modal
            modal.querySelector('#close-category-dialog').addEventListener('click', () => {
                modal.remove();
                dom.categoryDialog = null;
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    dom.categoryDialog = null;
                }
            });

            // Buscador din√°mico
            modal.querySelector('#category-items-search').addEventListener('input', (e) => {
                renderCategoryList(e.target.value);
            });
        }
        // Formatear dinero con puntos
        function formatMoney(amount) {
            if (typeof amount === 'string') amount = parseInt(amount);
            if (isNaN(amount)) return amount;
            return amount.toLocaleString('es-ES');
        }
        
        function createItemCard(item, category) {
            const isAlertActive = state.alerts.some(alert => alert.id === item.item_id);
            const justAlertedItemIds = arguments[2] || [];
            const isJustAlerted = justAlertedItemIds.includes(item.item_id);

            return `
                <div class="item-card${isJustAlerted ? ' alerted' : ''}" data-item-id="${item.item_id}" data-item-name="${item.display_name}">
                    <img src="${item.icon}" alt="${item.display_name}" class="item-image" loading="lazy">
                    <div class="item-info">
                        <p class="item-name">${item.display_name}</p>
                        ${item.quantity ? `<p class="item-quantity">Cantidad: ${item.quantity}</p>` : ''}
                        ${item.Date_End ? `<p class="item-countdown" data-end-date="${item.Date_End}">Calculando...</p>` : ''}
                    </div>
                    <button class="alert-button ${isAlertActive ? 'active' : ''}" data-item-id="${item.item_id}" data-item-name="${item.display_name}">
                        ${isAlertActive ? '‚úì Alerta Activa' : '+ Alerta'}
                    </button>
                </div>
            `;
        }

        // Renderiza la secci√≥n de nuevos √≠tems alertados
        function renderNewAlertedItemsSection(stockData, justAlertedItemIds) {
            const section = document.getElementById('new-alerted-items-section');
            const container = document.getElementById('new-alerted-items-container');
            // Buscar los √≠tems alertados en el stock actual
            let alertedItems = [];
            for (const key in CATEGORY_MAP) {
                if (stockData[key] && Array.isArray(stockData[key])) {
                    stockData[key].forEach(item => {
                        if (justAlertedItemIds.includes(item.item_id)) {
                            alertedItems.push(item);
                        }
                    });
                }
            }
            if (alertedItems.length > 0) {
                section.style.display = '';
                container.innerHTML = alertedItems.map(item => {
                    // Solo mostrar la card, sin bot√≥n de alerta
                    return `
                        <div class="item-card alerted" data-item-id="${item.item_id}" data-item-name="${item.display_name}">
                            <img src="${item.icon}" alt="${item.display_name}" class="item-image" loading="lazy">
                            <div class="item-info">
                                <p class="item-name">${item.display_name}</p>
                                ${item.quantity ? `<p class="item-quantity">Cantidad: ${item.quantity}</p>` : ''}
                                ${item.Date_End ? `<p class="item-countdown" data-end-date="${item.Date_End}">Calculando...</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                // Listeners para abrir modal de info
                container.querySelectorAll('.item-card[data-item-id]').forEach(card => {
                    card.addEventListener('click', () => {
                        showItemInfoModal(card.dataset.itemId);
                    });
                });
                startAllCountdowns();
            } else {
                section.style.display = 'none';
                container.innerHTML = '';
            }
        }

        function renderWeather(data) {
            const activeWeathers = data.weather.filter(w => w.active);
            if(activeWeathers.length === 0) {
                dom.weatherContainer.innerHTML = `<p style="padding: 1rem; color: var(--text-secondary);">No hay climas activos.</p>`;
                return;
            }
            
            dom.weatherContainer.innerHTML = activeWeathers.map(weather => {
                const isFav = state.weatherFavs && state.weatherFavs.includes(weather.weather_name);
                return `
                     <div class="item-card${isFav ? ' alerted' : ''}" style="cursor: default;">
                        <img src="${weather.icon}" alt="${weather.weather_name}" class="item-image">
                        <div class="item-info">
                            <p class="item-name">${weather.weather_name}</p>
                            <p class="item-countdown" data-end-date="${new Date(weather.end_duration_unix*1000)}">Calculando...</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            startAllCountdowns();
        }
        
        function addManualNameAlert(name) {
            // No duplicar (ignorando may√∫sculas y espacios)
            const norm = n => n.toLowerCase().replace(/\s+/g, '');
            if (state.alerts.some(a => norm(a.name||a.id||'') === norm(name))) return;
            state.alerts.push({ name: name, id: null, icon: null });
            saveStateToLocalStorage();
            renderAlertList();
        }

        function addManualAlert(item) {
            if (state.alerts.some(a => a.id === item.item_id)) return;
            state.alerts.push({ id: item.item_id, name: item.display_name, icon: item.icon });
            saveStateToLocalStorage();
            renderAlertList();
            document.querySelectorAll(`.alert-button[data-item-id="${item.item_id}"]`).forEach(btn => {
                btn.classList.add('active');
                btn.textContent = '‚úì Alerta Activa';
            });
        }

        function renderAlertList() {
            dom.travelingMerchantToggle.checked = state.travelingMerchantAlert;

            if (state.alerts.length === 0) {
                dom.alertList.innerHTML = `<p>No has a√±adido ninguna alerta. Haz clic en "+ Alerta" en cualquier √≠tem.</p>`;
                return;
            }
            
            dom.alertList.innerHTML = state.alerts.map(alert => `
                <div class="alert-list-item">
                    <span style="display:flex;align-items:center;gap:0.5rem;">
                        ${alert.icon ? `<img src="${alert.icon}" alt="icon" style="width:24px;height:24px;object-fit:contain;">` : ''}
                        ${alert.name}
                    </span>
                    <button class="remove-alert-btn" data-item-id="${alert.id}">&times;</button>
                </div>
            `).join('');

            // A√±adir listeners a los botones de eliminar
            document.querySelectorAll('.remove-alert-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    toggleAlert(btn.dataset.itemId, null, btn);
                });
            });
        }
        
        function addCardListeners() {
            document.querySelectorAll('.alert-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que se abra el modal al hacer clic en el bot√≥n
                    toggleAlert(btn.dataset.itemId, btn.dataset.itemName, btn);
                });
            });
            document.querySelectorAll('.item-card[data-item-id]').forEach(card => {
                card.addEventListener('click', () => {
                   showItemInfoModal(card.dataset.itemId);
                });
            });
            startAllCountdowns();
        }

        // --- L√ìGICA DE ALERTAS ---

        function toggleAlert(itemId, itemName, buttonElement) {
            const alertIndex = state.alerts.findIndex(alert => alert.id === itemId);

            if (alertIndex > -1) { // La alerta existe, la eliminamos
                state.alerts.splice(alertIndex, 1);
            } else { // No existe, la a√±adimos
                let icon = '';
                const found = state.allItems.find(i => i.item_id === itemId);
                if (found) icon = found.icon;
                state.alerts.push({ id: itemId, name: itemName, icon });
            }
            saveStateToLocalStorage();
            renderAlertList();
            document.querySelectorAll(`.alert-button[data-item-id="${itemId}"]`).forEach(btn => {
                const isActive = alertIndex === -1;
                btn.classList.toggle('active', isActive);
                btn.textContent = isActive ? '‚úì Alerta Activa' : '+ Alerta';
            });
        }
        
        function checkForAlerts(newStockData) {
            // Ahora acepta weatherData como segundo argumento
            const weatherData = arguments[1];
            const justAlertedItemIds = [];
            // 0. Chequear climas favoritos usando weatherData
            let shouldPlayWeatherSound = false;
            if (state.weatherFavs && Array.isArray(state.weatherFavs) && weatherData && Array.isArray(weatherData.weather)) {
                const activeWeathers = weatherData.weather.filter(w => w.active);
                activeWeathers.forEach(weather => {
                    if (state.weatherFavs.includes(weather.weather_name)) {
                        shouldPlayWeatherSound = true;
                    }
                });
            }
            // Recopilar √≠tems actuales por id y sus fechas
            const currentItems = {};
            for (const key in CATEGORY_MAP) {
                if (newStockData[key] && Array.isArray(newStockData[key])) {
                    newStockData[key].forEach(item => {
                        currentItems[item.item_id] = {
                            start: item.start_date_unix || null,
                            end: item.end_date_unix || null,
                            name: item.display_name
                        };
                    });
                }
            }

            let shouldPlaySound = false;

            // 1. Chequear √≠tems en alerta (por id o por nombre normalizado)
            const norm = n => (n||'').toLowerCase().replace(/\s+/g, '');
            state.alerts.forEach((alert, idx) => {
                let foundId = alert.id;
                let foundName = alert.name;
                let foundIcon = alert.icon;
                let item = null;
                if (alert.id && currentItems[alert.id]) {
                    item = currentItems[alert.id];
                } else if (!alert.id && alert.name) {
                    // Buscar por nombre normalizado en currentItems
                    for (const itemId in currentItems) {
                        if (norm(currentItems[itemId].name) === norm(alert.name)) {
                            item = currentItems[itemId];
                            foundId = itemId;
                            foundName = currentItems[itemId].name;
                            // Buscar icono en allItems
                            const found = state.allItems.find(i => i.item_id === itemId);
                            foundIcon = found ? found.icon : null;
                            // Actualizar alerta a formato completo
                            state.alerts[idx] = { id: foundId, name: foundName, icon: foundIcon };
                            saveStateToLocalStorage();
                            break;
                        }
                    }
                }
                if (item && foundId) {
                    // Verificar si ya se notific√≥ para este rango
                    const alreadyNotified = state.notifiedItems.some(n => n.id === foundId && n.start === item.start && n.end === item.end);
                    if (!alreadyNotified) {
                        console.log(`ALERTA: ¬°${foundName} est√° disponible!`);
                        state.notifiedItems.push({ id: foundId, start: item.start, end: item.end });
                        cleanNotifiedItems();
                        shouldPlaySound = true;
                        justAlertedItemIds.push(foundId);
                    }
                }
            });

            // 2. Chequear Mercader Ambulante
            const newMerchantStatus = newStockData.travelingmerchant_stock?.status;
            const oldMerchantStatus = state.lastStockData?.travelingmerchant_stock?.status;
            if (state.travelingMerchantAlert && newMerchantStatus === "In Town" && oldMerchantStatus === "Not in town") {
                console.log(`ALERTA: ¬°El Mercader Ambulante ha llegado!`);
                shouldPlaySound = true;
            }

            // Si hay clima favorito activo, reproducir sonido aunque no haya otros triggers
            if (shouldPlaySound || shouldPlayWeatherSound) {
                playAlertSound();
                saveStateToLocalStorage();
            }

            // En la primera carga, alertar de todo lo que est√© en alerta y presente
            if (!state.lastStockData) {
                let firstLoadSound = false;
                state.alerts.forEach(alert => {
                    const item = currentItems[alert.id];
                    if (item) {
                        const alreadyNotified = state.notifiedItems.some(n => n.id === alert.id && n.start === item.start && n.end === item.end);
                        if (!alreadyNotified) {
                            console.log(`ALERTA (primera carga): ¬°${item.name} est√° disponible!`);
                            state.notifiedItems.push({ id: alert.id, start: item.start, end: item.end });
                            cleanNotifiedItems();
                            firstLoadSound = true;
                            justAlertedItemIds.push(alert.id);
                        }
                    }
                });
                // Tambi√©n reproducir sonido si hay clima favorito activo en la primera carga
                if (firstLoadSound || shouldPlayWeatherSound) {
                    playAlertSound();
                    saveStateToLocalStorage();
                }
            }
            return justAlertedItemIds;
        }

        // --- LIMPIEZA DE notifiedItems ---
        function cleanNotifiedItems() {
            if (state.notifiedItems.length >= 200) {
                state.notifiedItems.splice(0, 100);
            }
        }

        function playAlertSound() {
            console.log("Reproduciendo sonido de alerta...");
            dom.alertSound.volume = state.volume;

            dom.alertSound.currentTime = 0;
            dom.alertSound.play().catch(e => console.error("Error al reproducir sonido:", e));
        }

        // --- CONTADORES REGRESIVOS ---
        
        function formatTime(ms) {
            if (ms <= 0) return "Terminado";
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            const d = Math.floor(h / 24);

            const parts = [];
            if (d > 0) parts.push(`${d}d`);
            if (h % 24 > 0) parts.push(`${h % 24}h`);
            if (m % 60 > 0) parts.push(`${m % 60}m`);
            if (s % 60 > 0 && d === 0) parts.push(`${s % 60}s`); // Solo mostrar segundos si falta menos de un d√≠a

            return parts.join(' ');
        }
        
        function startCountdown(element) {
            const endDate = new Date(element.dataset.endDate);
            if (isNaN(endDate)) return;

            const update = () => {
                const remaining = endDate - new Date();
                if (remaining <= 0) {
                    element.textContent = "Terminado";
                    // Encontrar y eliminar el timer del array
                    const timerIndex = state.countdownTimers.findIndex(t => t.element === element);
                    if (timerIndex > -1) {
                         clearInterval(state.countdownTimers[timerIndex].intervalId);
                         state.countdownTimers.splice(timerIndex, 1);
                    }
                } else {
                    element.textContent = formatTime(remaining);
                }
            };
            
            update(); // llamada inicial
            const intervalId = setInterval(update, 1000);
            state.countdownTimers.push({ intervalId, element });
        }
        
        function startAllCountdowns() {
            document.querySelectorAll('.item-countdown').forEach(startCountdown);
        }

        function clearAllCountdowns() {
            state.countdownTimers.forEach(timer => clearInterval(timer.intervalId));
            state.countdownTimers = [];
        }
        
        // --- MODAL DE INFORMACI√ìN ---

        async function showItemInfoModal(itemId) {
            dom.modal.classList.add('visible');
            dom.modalTitle.innerHTML = 'Cargando...';
            dom.modalBody.innerHTML = '<p>Obteniendo detalles del √≠tem...</p>';

            try {
                let itemInfo;
                if (state.itemInfoCache.has(itemId)) {
                    itemInfo = state.itemInfoCache.get(itemId);
                } else {
                    const response = await fetch(`${API_ROUTES.info}${itemId}`);
                    handleRateLimit(response);
                    if (!response.ok) throw new Error('No se pudo obtener la informaci√≥n.');
                    itemInfo = await response.json();
                    state.itemInfoCache.set(itemId, itemInfo);
                }

                // Imagen a la izquierda, nombre y bot√≥n wiki a la derecha
                const wikiName = encodeURIComponent((itemInfo.display_name || '').replace(/ /g, '_'));
                const wikiUrl = `https://growagarden.fandom.com/wiki/${wikiName}`;
                const iconWiki = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>`;

                dom.modalTitle.innerHTML = `
                    <div style="display:flex;align-items:center;gap:1rem;">
                        ${itemInfo.icon ? `<img src="${itemInfo.icon}" alt="${itemInfo.display_name}" style="width:48px;height:48px;object-fit:contain;">` : ''}
                        <span style="font-size:1.2em;font-weight:600;">${itemInfo.display_name}</span>
                        <button id="open-wiki-btn" title="Abrir Wiki" style="background:none;border:none;cursor:pointer;padding:0;margin-left:0.5rem;display:flex;align-items:center;">${iconWiki}</button>
                    </div>
                `;
                dom.modalBody.innerHTML = `
                    <p>${itemInfo.description || 'Sin descripci√≥n.'}</p>
                    <p><strong>Rareza:</strong> ${itemInfo.rarity || 'N/A'}</p>
                    <p><strong>Precio de venta:</strong> ${itemInfo.price ? `${formatMoney(itemInfo.price)} ${itemInfo.currency}` : 'N/A'}</p>
                    <p><strong>Visto por √∫ltima vez:</strong> ${itemInfo.last_seen ? new Date(itemInfo.last_seen).toLocaleString() : 'N/A'}</p>
                `;
                // Listener para abrir la wiki en nueva pesta√±a
                setTimeout(() => {
                    const btn = document.getElementById('open-wiki-btn');
                    if (btn) {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            window.open(wikiUrl, '_blank');
                        });
                    }
                }, 0);

            } catch (error) {
                console.error("Error al mostrar info del √≠tem:", error);
                dom.modalBody.innerHTML = `<p style="color: var(--error-color);">${error.message}</p>`;
            }
        }
        
        function hideItemInfoModal() {
            dom.modal.classList.remove('visible');
        }

        // --- MANEJO DE ERRORES EN UI ---
        
        function displayError(message) {
            dom.errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function clearError() {
            dom.errorContainer.innerHTML = '';
        }

        // --- INICIAR LA APP ---
        initializeApp();
    });
    </script>
</body>
</html>
